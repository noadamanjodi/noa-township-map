<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Township Combined Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html,body{height:100%;margin:0;font-family:Segoe UI,Arial;background:#f4f6fb}
.app{height:100%;display:flex;flex-direction:column}
header{
  background:#003f88;color:#fff;
  padding:12px;font-size:18px;
  font-weight:600;text-align:center
}
.content{flex:1;display:flex;min-height:0}

.sidebar{
  width:330px;background:#fff;padding:14px;
  box-shadow:2px 0 12px rgba(0,0,0,.15);
  overflow:auto
}

.panel{margin-bottom:14px}
input,button{
  width:100%;padding:12px;
  border-radius:10px;border:1px solid #ccc;
  margin-top:8px;font-size:15px
}
button{cursor:pointer;font-weight:600;border:none;background:#ffd24d}
.reset{background:#e0e7ff;color:#003f88}

#msg{
  display:none;margin-top:10px;
  padding:10px;border-radius:8px;
  font-size:14px;font-weight:600;
  background:#ffe4e4;color:#b00020
}

.map-wrap{flex:1}
#map{width:100%;height:100%}
.leaflet-image-layer{pointer-events:none}

@media(max-width:768px){
  .content{flex-direction:column}
  .sidebar{width:100%}
}
</style>
</head>

<body>
<div class="app">
<header>Township Combined Map ‚Äì Sector 1 & 2</header>

<div class="content">

<aside class="sidebar">
  <div class="panel">
    <strong>Search Quarter</strong><br>
    <small>Format: <b>1-B-720</b> (Sector-Block-Quarter)</small>
    <input id="search" placeholder="1-B-66">
    <button onclick="doSearch()">üîç Find Quarter</button>
    <button class="reset" onclick="resetMap()">üîÑ Reset</button>
    <div id="msg"></div>
  </div>
</aside>

<div class="map-wrap">
  <div id="map"></div>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= CONFIG ================= */
const IMG_W = 4400, IMG_H = 3080;
const IMG1 = "./sector1.png";
const IMG2 = "./sector2.png";
const JSON_URL = "./township_blocks.json";

/* ================= MAP ================= */
const map = L.map("map",{crs:L.CRS.Simple,minZoom:-4});
const bounds1 = [map.unproject([0,IMG_H],0), map.unproject([IMG_W,0],0)];
const bounds2 = [map.unproject([0,IMG_H*2],0), map.unproject([IMG_W,IMG_H],0)];
const fullBounds = [map.unproject([0,IMG_H*2],0), map.unproject([IMG_W,0],0)];

L.imageOverlay(IMG1,bounds1).addTo(map);
L.imageOverlay(IMG2,bounds2).addTo(map);
map.fitBounds(fullBounds);

/* ================= STATE ================= */
let blocks=[], rects={}, active=null;
const layer = L.featureGroup().addTo(map);

/* ================= LOAD JSON ================= */
fetch(JSON_URL).then(r=>r.json()).then(j=>{
  blocks = j.blocks;
  drawAll();
});

/* ================= DRAW ================= */
function shift(b,mapNo){
  return mapNo===2
    ? [[b[0][0]-IMG_H,b[0][1]],[b[1][0]-IMG_H,b[1][1]]]
    : b;
}

function drawAll(){
  layer.clearLayers();
  rects={};

  blocks.forEach(b=>{
    const r=L.rectangle(
      shift(b.boundsLatLng,b.map),
      {
        color: b.sector===1 ? "#1976d2" : "#c62828",
        weight:2,
        fillOpacity:0.35
      }
    ).addTo(layer);

    r.bindTooltip(
      `Sector ${b.sector} | ${b.rangeText}`,
      {sticky:true}
    );

    rects[b.id]=r;
  });
}

/* ================= SEARCH ================= */
function doSearch(){
  hideMsg();
  const v = search.value.trim().toUpperCase();
  search.value = v; // auto uppercase

  const m = v.match(/^([12])\-([A-Z]\-\d+)$/);
  if(!m){ showMsg("Use exact format: 1-B-66"); return; }

  const sector = Number(m[1]);
  const qtr = m[2];

  const found = blocks.find(b =>
    b.sector===sector &&
    b.expanded.includes(qtr)
  );

  if(!found){ showMsg("Quarter not found in this sector"); return; }

  if(active){
    active.setStyle({weight:2,fillOpacity:0.35});
  }

  const r = rects[found.id];
  r.setStyle({color:"#2e7d32",weight:4,fillOpacity:0.6});
  active = r;
  map.fitBounds(r.getBounds().pad(0.35));
}

/* ================= RESET ================= */
function resetMap(){
  hideMsg();
  search.value="";
  if(active){
    active.setStyle({weight:2,fillOpacity:0.35});
    active=null;
  }
  map.fitBounds(fullBounds);
}

/* ================= MSG ================= */
function showMsg(t){
  msg.innerText=t;
  msg.style.display="block";
}
function hideMsg(){
  msg.style.display="none";
}
</script>
</body>
</html>
