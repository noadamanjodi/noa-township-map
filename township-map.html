<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Township Map – Interactive Finder</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
html,body{
  height:100%;
  margin:0;
  padding:0;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
:root{
  --sidebar:320px;
  --accent:#003f88;
  --panel:#ffffff;
  --muted:#6b7890;
  --btn:#ffd24d;
}
.app{
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#f5f7fb;
}
header{
  background:var(--accent);
  color:white;
  padding:12px 16px;
  font-size:18px;
  font-weight:600;
}
.content{
  flex:1;
  display:flex;
  min-height:0;
}
.sidebar{
  width:var(--sidebar);
  min-width:260px;
  padding:14px;
  background:white;
  box-shadow:2px 0 8px rgba(0,0,0,0.10);
  overflow:auto;
}
.panel{
  background:var(--panel);
  padding:12px;
  border-radius:10px;
  margin-bottom:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}
.tab{
  padding:12px;
  background:#eef4ff;
  margin-bottom:8px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.tab.active{
  background:#cfe1ff;
}
label.small{
  font-size:13px;
  color:var(--muted);
  margin-bottom:6px;
  display:block;
}
input[type="search"]{
  width:100%;
  padding:10px;
  border:1px solid #d7dfea;
  border-radius:8px;
  font-size:14px;
}
.btn{
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  margin-top:8px;
  background:var(--btn);
  cursor:pointer;
  font-weight:700;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.btn.alt{ background:#d4ed70; }
.btn.blue{ background:#b7d9ff; }
.btn.red{ background:#ff9c9c;}

#map{
  width:100%;
  height:100%;
  background:#e9e9e9;
}

.leaflet-tooltip.my-tooltip{
  background:rgba(0,0,0,0.75);
  color:white;
  padding:3px 7px;
  border-radius:4px;
  font-size:13px;
}
</style>

</head>
<body>

<div class="app">

<header>Interactive Township Map (Sector 1 • Sector 2 • Sector 3)</header>

<div class="content">

  <!-- Sidebar -->
  <aside class="sidebar">

    <div class="panel">
      <div class="tab active" data-sector="1">Sector 1</div>
      <div class="tab" data-sector="2">Sector 2</div>
      <div class="tab" data-sector="3">Sector 3</div>
    </div>

    <div class="panel">
      <label class="small">Search Block (e.g., B-720 or A-57)</label>
      <input id="searchBox" type="search" placeholder="Enter block" />
      <button class="btn" id="searchBtn">Find</button>
    </div>

    <!-- Admin Login -->
    <div class="panel">
      <button id="adminLoginBtn" class="btn" style="background:#ffd36c;">Admin Login</button>
    </div>

    <!-- ADMIN PANEL (Hidden) -->
    <div class="panel" id="adminPanel" style="display:none;">
      <label class="small"><b>Admin Tools</b></label>

      <button id="toggleEditor" class="btn" style="background:#f7c86c;">Enable Drawing</button>
      <button id="downloadJSON" class="btn alt">Download JSON</button>
      <button id="loadJSON" class="btn blue">Load JSON File</button>

      <button id="verifyBtn" class="btn" style="background:#a8ffbf;">Verify Blocks</button>
      <button id="missingBtn" class="btn red">Missing Blocks</button>

      <!-- NEW: GitHub Auto-Save Button -->
      <button id="saveGithubBtn" class="btn" style="background:#9cc6ff;">Save to GitHub</button>

      <input id="fileInput" type="file" accept=".json" style="display:none" />
    </div>

  </aside>

  <!-- Map -->
  <div style="flex:1;">
    <div id="map"></div>
  </div>

</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<!-- ================== PART 2: Map engine, sector loading, search ================== -->
<script>
/* ---------- IMAGE DIMENSIONS ---------- */
const IMG_W = 4400;
const IMG_H = 3080;

/* ---------- CORE APP STATE ---------- */
const APP = {
  currentSector: 1,
  images: {
    1: "./sector1.png",
    2: "./sector2.png",
    3: "./sector3.png"
  },
  data: {
    1: [],
    2: [],
    3: []
  },
  drawingLayer: {},
  editor: false,
  counter: 0
};

/* ---------- INITIALIZE LEAFLET MAP ---------- */
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -4,
  maxZoom: 4,
  zoomSnap: 0.2,
  attributionControl: false
});

let imgOverlay = null;

/* ---------- HELPER: compute image bounds from pixel size ---------- */
function imageBounds() {
  const sw = map.unproject([0, IMG_H], map.getMaxZoom());
  const ne = map.unproject([IMG_W, 0], map.getMaxZoom());
  return L.latLngBounds(sw, ne);
}

/* ---------- LOAD SECTOR IMAGE (adds overlay + layer group) ---------- */
async function loadSector(sector) {
  APP.currentSector = sector;

  // remove existing overlay
  if (imgOverlay) {
    try { map.removeLayer(imgOverlay); } catch(e){}
    imgOverlay = null;
  }

  const url = APP.images[sector];
  // ensure image loads (graceful)
  const img = new Image();
  img.src = url;
  await new Promise(res => { img.onload = res; img.onerror = res; });

  const bounds = imageBounds();
  imgOverlay = L.imageOverlay(url, bounds).addTo(map);

  map.setMaxBounds(bounds);
  map.fitBounds(bounds);

  // ensure drawing group exists
  if (!APP.drawingLayer[sector]) {
    APP.drawingLayer[sector] = L.featureGroup().addTo(map);
  }

  // hide other sector layers
  Object.keys(APP.drawingLayer).forEach(s => {
    if (Number(s) !== sector) {
      try { map.removeLayer(APP.drawingLayer[s]); } catch(e){}
    }
  });

  // add current sector drawing layer
  APP.drawingLayer[sector].addTo(map);

  // render any stored rectangles
  renderRectangles(sector);
}

/* ---------- RENDER rectangles for a sector ---------- */
function renderRectangles(sector) {
  const grp = APP.drawingLayer[sector];
  grp.clearLayers();

  if (!Array.isArray(APP.data[sector])) return;

  APP.data[sector].forEach(item => {
    try {
      const rect = L.rectangle(item.boundsLatLng, {
        color: "#ff9800",
        weight: 2,
        fillColor: "#ffd280",
        fillOpacity: 0.35
      }).addTo(grp);

      rect.bindTooltip(item.rangeText, { className: "my-tooltip" });
      item._layer = rect;
    } catch (err) {
      console.warn("Invalid rectangle item", item, err);
    }
  });
}

/* ---------- Expand range string (A-57, B-720-725) ---------- */
function expandRange(rangeStr) {
  if (!rangeStr || typeof rangeStr !== "string") return [];
  const s = rangeStr.replace(/\s+/g, "").toUpperCase();
  const m = s.match(/^([A-Z])[-]?(\d+)(?:-(\d+))?$/);
  if (!m) return [];
  const L = m[1];
  const a = Number(m[2]);
  const b = m[3] ? Number(m[3]) : a;
  const lo = Math.min(a, b);
  const hi = Math.max(a, b);
  const out = [];
  for (let i = lo; i <= hi; i++) out.push(`${L}-${i}`);
  return out;
}

/* ---------- SEARCH (button) ---------- */
document.getElementById("searchBtn").onclick = () => {
  const raw = document.getElementById("searchBox").value.trim().toUpperCase();
  if (!raw) { alert("Enter A-57 or B-720"); return; }

  const m = raw.match(/^([A-Z])[-]?(\d+)$/);
  if (!m) { alert("Use format A-57 or B-720"); return; }

  const key = `${m[1]}-${m[2]}`;
  let found = null;

  // search current sector first, then others
  [APP.currentSector, 1, 2, 3].forEach(sec => {
    if (found) return;
    const list = APP.data[sec] || [];
    list.forEach(block => {
      if (block.expanded && block.expanded.includes(key)) {
        found = { sector: sec, block };
      }
    });
  });

  if (!found) { alert("Block not found."); return; }

  // switch sector if needed
  if (found.sector !== APP.currentSector) {
    document.querySelectorAll(".tab").forEach(t => {
      t.classList.toggle("active", Number(t.dataset.sector) === found.sector);
    });
    loadSector(found.sector);
  }

  setTimeout(() => {
    const layer = found.block._layer;
    if (!layer) return;
    map.fitBounds(layer.getBounds().pad(0.35));
    layer.setStyle({ color: "#ffee00", weight: 4, fillOpacity: 0.6 });
    setTimeout(() => layer.setStyle({ color: "#ff9800", weight: 2, fillOpacity: 0.35 }), 3000);
  }, 500);
};

/* ---------- TAB CLICK HANDLING ---------- */
document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    loadSector(Number(tab.dataset.sector));
  };
});

/* ---------- INITIAL LOAD (image + empty data; PART 3 will auto-load JSON if present) ---------- */
loadSector(1);
</script>
<!-- ================== END PART 2 ================== -->
<!-- ================== PART 3: Admin Tools + GitHub Auto-Save ================== -->
<script>
/* ======================================================
   ADMIN LOGIN (Password Protected)
====================================================== */
const ADMIN_PASSWORD = "NALCO123";

document.getElementById("adminLoginBtn").onclick = () => {
  const pwd = prompt("Enter Admin Password:");
  if (pwd === ADMIN_PASSWORD) {
    document.getElementById("adminPanel").style.display = "block";
    alert("Admin Mode Enabled");
  } else {
    alert("Incorrect Password");
  }
};

/* ======================================================
   DRAWING SETUP
====================================================== */
const drawControl = new L.Control.Draw({
  draw: {
    marker: false,
    circle: false,
    polyline: false,
    circlemarker: false,
    polygon: false,
    rectangle: {
      shapeOptions: {
        color: "#ff9800",
        weight: 2,
        fillColor: "#ffd280",
        fillOpacity: 0.35
      }
    }
  }
});

/* Enable / Disable Drawing Mode */
document.getElementById("toggleEditor").onclick = () => {
  APP.editor = !APP.editor;
  document.getElementById("toggleEditor").innerText =
    APP.editor ? "Disable Drawing" : "Enable Drawing";

  if (APP.editor) map.addControl(drawControl);
  else map.removeControl(drawControl);
};

/* ======================================================
   AUTOSAVE (Browser)
====================================================== */
function autosave() {
  localStorage.setItem("township_autosave", JSON.stringify(APP.data));
}
function autoload() {
  const saved = localStorage.getItem("township_autosave");
  if (saved) {
    APP.data = JSON.parse(saved);
    console.log("Auto-loaded from browser storage");
  }
}
autoload();

/* ======================================================
   HANDLE RECTANGLE CREATION
====================================================== */
map.on(L.Draw.Event.CREATED, (e) => {
  if (!APP.editor) return;

  const layer = e.layer;
  const rangeText = prompt("Enter block range (e.g., B-529-540):");
  if (!rangeText) return;

  const expanded = expandRange(rangeText);
  if (expanded.length === 0) {
    alert("Invalid Range Format.");
    return;
  }

  const b = layer.getBounds();

  const item = {
    id: "id_" + (++APP.counter),
    sector: APP.currentSector,
    rangeText: rangeText.toUpperCase(),
    expanded,
    boundsLatLng: [
      [b.getSouth(), b.getWest()],
      [b.getNorth(), b.getEast()]
    ]
  };

  APP.data[APP.currentSector].push(item);
  autosave();

  layer.bindTooltip(item.rangeText, { className: "my-tooltip" });
  APP.drawingLayer[APP.currentSector].addLayer(layer);

  alert("Saved.");
});

/* ======================================================
   DOWNLOAD JSON (Manual)
====================================================== */
document.getElementById("downloadJSON").onclick = () => {
  const blob = new Blob(
    [JSON.stringify({ sectors: APP.data }, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "township_map_ranges.json";
  a.click();

  URL.revokeObjectURL(url);
};

/* ======================================================
   UPLOAD JSON (Manual)
====================================================== */
document.getElementById("loadJSON").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = (evt) => {
  const file = evt.target.files[0];
  const reader = new FileReader();

  reader.onload = (e) => {
    APP.data = JSON.parse(e.target.result).sectors;
    renderRectangles(APP.currentSector);
    autosave();
    alert("JSON Loaded Successfully.");
  };

  reader.readAsText(file);
};

/* ======================================================
   VERIFY BLOCK COUNTS
====================================================== */
document.getElementById("verifyBtn").onclick = () => {
  let msg = "";

  [1, 2, 3].forEach(sec => {
    const ranges = APP.data[sec].length;
    const blocks = APP.data[sec].reduce((sum, item) => sum + item.expanded.length, 0);

    msg += `Sector ${sec}:\n`;
    msg += `  Ranges: ${ranges}\n`;
    msg += `  Blocks: ${blocks}\n\n`;
  });

  alert(msg);
};

/* ======================================================
   MISSING BLOCK DETECTOR
====================================================== */
document.getElementById("missingBtn").onclick = () => {
  let report = "";

  [1, 2, 3].forEach(sec => {
    report += `Sector ${sec}:\n`;

    const all = [];
    APP.data[sec].forEach(item => all.push(...item.expanded));

    const groups = {};

    all.forEach(b => {
      const [L, n] = b.split("-");
      if (!groups[L]) groups[L] = [];
      groups[L].push(Number(n));
    });

    Object.keys(groups).forEach(L => {
      const nums = groups[L].sort((a, b) => a - b);
      for (let i = nums[0]; i <= nums[nums.length - 1]; i++) {
        if (!nums.includes(i)) {
          report += `  Missing → ${L}-${i}\n`;
        }
      }
    });

    report += "\n";
  });

  alert(report);
};

/* ======================================================
   AUTO-LOAD JSON FROM GITHUB
====================================================== */
fetch("./township_map_ranges.json")
  .then(r => r.json())
  .then(json => {
    APP.data = json.sectors;
    console.log("Loaded JSON from GitHub");
  })
  .catch(() => console.warn("No JSON found on GitHub yet."));
  

/* ======================================================
   ⭐ GITHUB AUTO-SAVE BUTTON ⭐
====================================================== */

document.getElementById("saveGithubBtn").onclick = async () => {

  let token = localStorage.getItem("GITHUB_TOKEN");

  if (!token) {
    token = prompt("Enter your GitHub personal access token:");
    if (!token) return alert("Token required!");
    localStorage.setItem("GITHUB_TOKEN", token);
  }

  const username = "noadamanjodi";
  const repo = "noa-township-map";
  const filePath = "township_map_ranges.json";

  const apiURL = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;

  // First: Get SHA of existing file
  const getRes = await fetch(apiURL, {
    headers: { "Authorization": "Bearer " + token }
  });

  let sha = null;
  if (getRes.status === 200) {
    const fileData = await getRes.json();
    sha = fileData.sha;
  }

  // Prepare updated content
  const newContent = btoa(JSON.stringify({ sectors: APP.data }, null, 2));

  // Upload updated JSON
  const uploadRes = await fetch(apiURL, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Auto-update township_map_ranges.json",
      content: newContent,
      sha: sha
    })
  });

  if (uploadRes.status === 201 || uploadRes.status === 200) {
    alert("JSON successfully saved to GitHub!");
  } else {
    alert("Failed to save. Check your GitHub token permissions.");
  }
};
</script>
<!-- ================== END PART 3 ================== -->
</body>
</html>
