<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Township Map â€“ Interactive Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    html,body{
      height:100%;
      margin:0;
      padding:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    :root{
      --sidebar-w:320px;
      --accent:#003f88;
      --panel-bg:#ffffff;
      --muted:#6b7890;
      --btn:#ffd24d;
    }

    .app {
      height:100vh;
      display:flex;
      flex-direction:column;
      background:#f5f7fb;
    }

    header.app-header {
      background:var(--accent);
      color:white;
      padding:12px 16px;
      font-weight:600;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .content {
      flex:1;
      display:flex;
      min-height:0;
    }

    .sidebar {
      width:var(--sidebar-w);
      min-width:260px;
      background:var(--panel-bg);
      box-shadow:2px 0 8px rgba(20,30,60,0.06);
      padding:14px;
      box-sizing:border-box;
      overflow:auto;
    }

    .panel {
      background:var(--panel-bg);
      border-radius:8px;
      padding:10px;
      margin-bottom:12px;
      box-shadow:0 6px 18px rgba(10,20,40,0.04);
    }

    .tabs { display:flex; flex-direction:column; gap:8px; }

    .tab {
      padding:12px;
      border-radius:8px;
      background:#eef4ff;
      cursor:pointer;
      font-weight:600;
      color:#123;
      border:1px solid rgba(10,20,40,0.04);
    }
    .tab.active { background:#cfe1ff; color:#02284b; }

    label.small { font-size:13px; color:var(--muted); margin-bottom:6px; display:block; }

    input[type="text"], input[type="search"] {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e1e7f0;
      box-sizing:border-box;
      font-size:14px;
    }

    .btn {
      display:inline-block;
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:var(--btn);
      font-weight:700;
      margin-top:8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .btn.alt { background:#d4ed70; }
    .btn.blue { background:#b7d9ff; color:#032a50; }

    .map-wrap {
      flex:1;
      min-height:0;
      position:relative;
      overflow:hidden;
      background:#e9e9e9;
    }

    #map {
      flex:1;
      width:100%;
      height:100%;
      background:#dcdcdc;
    }

    .zoom-col {
      position:absolute;
      left:var(--sidebar-w);
      top:16px;
      z-index:1200;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-left:8px;
    }

    /* ðŸ”¥ IMPORTANT FIX â€” Allow drawing on PNG image overlays */
    .leaflet-image-layer {
        pointer-events: none !important;
    }

    @media (max-width:900px){
      .sidebar{ display:none; }
      .zoom-col { left:8px; }
    }

    .leaflet-tooltip.my-tooltip {
      background:rgba(0,0,0,0.7);
      color:white;
      border-radius:4px;
      padding:4px 8px;
      font-size:13px;
    }
  </style>

</head>
<body>
  <div class="app">
    <header class="app-header">Interactive Township Map (Sector 1 â€¢ Sector 2 â€¢ Sector 3)</header>

    <div class="content">
      
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        
        <div class="panel">
          <div class="tabs">
            <div class="tab active" data-sector="1">Sector 1</div>
            <div class="tab" data-sector="2">Sector 2</div>
            <div class="tab" data-sector="3">Sector 3</div>
          </div>
        </div>

        <div class="panel">
          <label class="small">Search Block</label>
          <input id="searchInput" type="search" placeholder="B-720 or A-57" />
          <button id="searchBtn" class="btn">Find</button>
        </div>

        <div class="panel">
          <label class="small">Admin Mode</label>
          <button id="toggleEditor" class="btn" style="background:#f7c86c;">Enable Drawing</button>
          <button id="downloadJSON" class="btn alt">Download JSON</button>
          <button id="loadJSON" class="btn blue">Load JSON File</button>
          <input id="fileInput" type="file" accept=".json" style="display:none" />
        </div>

      </aside>

      <!-- MAP -->
      <div class="map-wrap">
        <div id="map"></div>
      </div>

    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
/* ------------------- CONFIG ------------------- */
const IMG_W = 4400;
const IMG_H = 3080;

const APP = {
  currentSector: 1,
  images:{
    1:"./sector1.png",
    2:"./sector2.png",
    3:"./sector3.png"
  },
  data:{1:[],2:[],3:[]},
  drawingLayer:{},
  editor:false,
  counter:0
};

/* ------------------- MAP SETUP ------------------- */
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom:-4,
  maxZoom:4,
  zoomSnap:0.2,
});

let imgOverlay=null;

function imageBounds(){
  const sw = map.unproject([0,IMG_H], map.getMaxZoom());
  const ne = map.unproject([IMG_W,0], map.getMaxZoom());
  return L.latLngBounds(sw,ne);
}

async function loadSector(sector){
  APP.currentSector=sector;
  const bounds=imageBounds();

  if(imgOverlay) map.removeLayer(imgOverlay);
  imgOverlay = L.imageOverlay(APP.images[sector], bounds).addTo(map);

  map.setMaxBounds(bounds);
  map.fitBounds(bounds);

  if(!APP.drawingLayer[sector]){
    APP.drawingLayer[sector]=L.featureGroup().addTo(map);
  }

  Object.keys(APP.drawingLayer).forEach(s=>{
    if(Number(s)!==sector) map.removeLayer(APP.drawingLayer[s]);
  });

  APP.drawingLayer[sector].addTo(map);
  renderRects(sector);
}

function renderRects(sector){
  const grp = APP.drawingLayer[sector];
  grp.clearLayers();

  APP.data[sector].forEach(item=>{
    const rect=L.rectangle(item.boundsLatLng,{
      color:"#ff9800",
      weight:2,
      fillColor:"#ffd280",
      fillOpacity:0.35
    }).addTo(grp);

    rect.bindTooltip(item.rangeText,{className:"my-tooltip"});
    item._layer=rect;
  });
}

/* ------------------- SEARCH ------------------- */
function expandRange(str){
  str=str.replace(/\s+/g,"").toUpperCase();
  const m=str.match(/^([A-Z])[-]?(\d+)(?:-(\d+))?$/);
  if(!m) return [];

  const letter=m[1];
  const s=Number(m[2]);
  const e=m[3]?Number(m[3]):s;

  let out=[];
  for(let i=Math.min(s,e); i<=Math.max(s,e); i++){
    out.push(`${letter}-${i}`);
  }
  return out;
}

document.getElementById("searchBtn").onclick=()=>{
  const raw=document.getElementById("searchInput").value.trim().toUpperCase();
  if(!raw){alert("Enter block.");return;}

  const m=raw.match(/^([A-Z])[-]?(\d+)$/);
  if(!m){alert("Use A-57 format.");return;}

  const key=`${m[1]}-${m[2]}`;

  let found=null;

  [APP.currentSector,1,2,3].forEach(sec=>{
    if(found) return;
    APP.data[sec].forEach(b=>{
      if(b.expanded.includes(key)){
        found={sector:sec,block:b};
      }
    });
  });

  if(!found){alert("Block not found.");return;}

  if(found.sector!==APP.currentSector){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", Number(t.dataset.sector)==found.sector);
    });
    loadSector(found.sector);
  }

  setTimeout(()=>{
    const layer=found.block._layer;
    const b=layer.getBounds();
    map.fitBounds(b.pad(0.35));

    layer.setStyle({color:"#ffee00",weight:4});
    setTimeout(()=>layer.setStyle({color:"#ff9800",weight:2}),3000);
  },400);
};

/* ------------------- TABS ------------------- */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    loadSector(Number(t.dataset.sector));
  };
});

/* ------------------- DRAWING ------------------- */
const drawControl = new L.Control.Draw({
  draw:{
    marker:false,
    circle:false,
    circlemarker:false,
    polyline:false,
    polygon:false,
    rectangle:{
      shapeOptions:{
        color:"#ff9800",
        weight:2,
        fillOpacity:0.35
      }
    }
  }
});

document.getElementById("toggleEditor").onclick=()=>{
  APP.editor=!APP.editor;

  document.getElementById("toggleEditor").textContent =
    APP.editor ? "Disable Drawing" : "Enable Drawing";

  if(APP.editor) map.addControl(drawControl);
  else map.removeControl(drawControl);
};

map.on(L.Draw.Event.CREATED, e=>{
  if(!APP.editor) return;

  const layer=e.layer;
  const range=prompt("Enter block range (e.g., B-529-540):");
  if(!range) return;

  const expanded=expandRange(range);
  if(expanded.length===0){
    alert("Invalid range.");
    return;
  }

  const b=layer.getBounds();

  const item={
    id:"id_"+(++APP.counter),
    sector:APP.currentSector,
    rangeText:range.toUpperCase(),
    expanded,
    boundsLatLng:[
      [b.getSouth(),b.getWest()],
      [b.getNorth(),b.getEast()]
    ]
  };

  APP.data[APP.currentSector].push(item);

  layer.bindTooltip(item.rangeText,{className:"my-tooltip"});
  APP.drawingLayer[APP.currentSector].addLayer(layer);

  alert("Block saved.");
});

/* ------------------- JSON SAVE/LOAD ------------------- */
document.getElementById("downloadJSON").onclick=()=>{
  const json=JSON.stringify({sectors:APP.data},null,2);
  const blob=new Blob([json],{type:"application/json"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="township_map_ranges.json";
  a.click();

  URL.revokeObjectURL(url);
};

document.getElementById("loadJSON").onclick=()=>{
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      APP.data=JSON.parse(ev.target.result).sectors;
      renderRects(APP.currentSector);
      alert("JSON Loaded.");
    }catch(e){
      alert("Invalid JSON.");
    }
  };
  reader.readAsText(file);
};

/* ------------------- INITIAL LOAD ------------------- */
loadSector(1);
</script>

</body>
</html>
