<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Township Map – Interactive Finder</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- Prevent Google Sites iframe scroll issues -->
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; 
    font-family: Arial, sans-serif;
    background: #f5f7fb;
  }
  #wrapper {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #003f88;
    padding: 12px 16px;
    color: white;
    font-size: 18px;
    font-weight: 600;
  }
  #main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #sidebar {
    width: 250px;
    min-width: 240px;
    background: white;
    padding: 12px;
    overflow-y: auto;
    box-shadow: 2px 0 6px rgba(0,0,0,0.08);
  }
  #map {
    flex: 1;
    height: 100%;
  }
  .panel {
    margin-bottom: 16px;
    padding: 12px;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(10,20,40,0.06);
  }
  label {
    font-size: 13px;
    margin-bottom: 4px;
    display: block;
  }
  input[type="text"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccd4e0;
    border-radius: 6px;
    box-sizing: border-box;
  }
  .btn {
    padding: 8px 10px;
    background: #ffd24d;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  .tab {
    padding: 8px;
    background: #e8eefc;
    margin-bottom: 6px;
    border-radius: 6px;
    cursor: pointer;
  }
  .tab.active {
    background: #c8dafc;
    font-weight: 700;
  }
</style>

<!-- Leaflet libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet.draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

</head>
<body>

<div id="wrapper">

<header>Interactive Township Map (Sector 1 • Sector 2 • Sector 3)</header>

<div id="main">

<!-- SIDEBAR -->
<div id="sidebar">

  <div class="panel">
    <div class="tab active" data-sector="1">Sector 1</div>
    <div class="tab" data-sector="2">Sector 2</div>
    <div class="tab" data-sector="3">Sector 3</div>
  </div>

  <div class="panel">
    <label>Search Block</label>
    <input id="searchBox" placeholder="Example: B-720 or A-57">
    <button id="btnSearch" class="btn" style="margin-top:8px;width:100%;">Find</button>
  </div>

  <div class="panel">
    <label>Admin Mode</label>
    <button id="btnAdmin" class="btn" style="width:100%;background:#f7c86c;">Enable Drawing</button>

    <button id="btnDownload" class="btn" style="margin-top:8px;width:100%;background:#d4ed70;">
      Download JSON
    </button>

    <button id="btnLoad" class="btn" style="margin-top:8px;width:100%;background:#b7d9ff;">
      Load JSON File
    </button>

    <input type="file" id="jsonLoader" style="display:none" accept=".json">
  </div>

</div>

<!-- MAP AREA -->
<div id="map"></div>

</div></div>

<script>

/* ---------------------------------------------------------
    CORE APP STATE
------------------------------------------------------------ */

const state = {
  currentSector: 1,
images: {
  1: "./sector1.png",
  2: "./sector2.png",
  3: "./sector3.png"
},
  data: { 1:[], 2:[], 3:[] },
  drawingLayer: {},
  editor: false,
  counter: 0
};

/* ---------------------------------------------------------
    MAP INITIALIZATION
------------------------------------------------------------ */

const map = L.map("map", {
  crs: L.CRS.Simple,
  zoomSnap: 0.2,
  minZoom: -4
});

let imgOverlay;

/* ---------------------------------------------------------
    LOAD SECTOR MAP IMAGE
------------------------------------------------------------ */

async function loadSector(sector) {
  state.currentSector = sector;

  const url = state.images[sector];
  const img = new Image();
  img.src = url;

 await new Promise(resolve => {
  img.onload = resolve;
  img.onerror = resolve;
});

  const w = img.width || 2000;
  const h = img.height || 1200;

  const southWest = map.unproject([0, h], map.getMaxZoom());
  const northEast = map.unproject([w, 0], map.getMaxZoom());
  const bounds = new L.LatLngBounds(southWest, northEast);

  if (imgOverlay) map.removeLayer(imgOverlay);

  imgOverlay = L.imageOverlay(url, bounds).addTo(map);

  map.setMaxBounds(bounds);
  map.fitBounds(bounds);

  // drawing layer
  if (!state.drawingLayer[sector]) {
    state.drawingLayer[sector] = L.featureGroup().addTo(map);
  }

  Object.keys(state.drawingLayer).forEach(s=>{
    if (parseInt(s) !== sector) map.removeLayer(state.drawingLayer[s]);
  });

  state.drawingLayer[sector].addTo(map);
  renderStoredRectangles(sector);
}

/* ---------------------------------------------------------
    EXPAND RANGE STR (A-57-64 → [A-57,A-58,...])
------------------------------------------------------------ */

function expandRange(str) {
  str = str.replace(/\s+/g,"").toUpperCase();
  const m = str.match(/^([A-Z])[-]?(\d+)(?:-(\d+))?$/);
  if (!m) return [];
  const letter = m[1];
  const start = Number(m[2]);
  const end = m[3] ? Number(m[3]) : start;
  const lo = Math.min(start,end);
  const hi = Math.max(start,end);

  const arr = [];
  for (let i=lo; i<=hi; i++) arr.push(`${letter}-${i}`);
  return arr;
}

/* ---------------------------------------------------------
    ADMIN: DRAW RECTANGLE
------------------------------------------------------------ */

const drawControl = new L.Control.Draw({
  draw: {
    marker:false,
    circle:false,
    circlemarker:false,
    polyline:false,
    polygon:false,
    rectangle: { shapeOptions:{ color:"#ff9800", weight:2 } }
  }
});

document.getElementById("btnAdmin").onclick = () => {
  state.editor = !state.editor;
  document.getElementById("btnAdmin").textContent =
    state.editor ? "Disable Drawing" : "Enable Drawing";

  if (state.editor) map.addControl(drawControl);
  else map.removeControl(drawControl);
};

map.on(L.Draw.Event.CREATED, e => {
  if (!state.editor) return;
  const layer = e.layer;
  const range = prompt("Enter block range (e.g. B-529-540 or A-57):");

  if (!range) return;

  const expanded = expandRange(range);
  const b = layer.getBounds();
  const item = {
    id: "id_"+(++state.counter),
    sector: state.currentSector,
    rangeText: range.toUpperCase(),
    expanded,
    boundsLatLng: [
      [b.getSouth(), b.getWest()],
      [b.getNorth(), b.getEast()]
    ]
  };
  state.data[state.currentSector].push(item);

  layer.bindTooltip(item.rangeText);
  state.drawingLayer[state.currentSector].addLayer(layer);
});

/* ---------------------------------------------------------
    RENDER SAVED RECTANGLES
------------------------------------------------------------ */

function renderStoredRectangles(sector) {
  const grp = state.drawingLayer[sector];
  grp.clearLayers();

  state.data[sector].forEach(item => {
    const r = L.rectangle(item.boundsLatLng, {
      color:"#ff9800",
      weight:2,
      fillColor:"#ffd280",
      fillOpacity:0.35
    }).addTo(grp);

    r.bindTooltip(item.rangeText);
    item._layer = r;
  });
}

/* ---------------------------------------------------------
    SEARCH FUNCTION
------------------------------------------------------------ */

document.getElementById("btnSearch").onclick = () => {
  const val = document.getElementById("searchBox").value.trim().toUpperCase();
  if (!val) return alert("Enter A-57 or B-720");

  const m = val.match(/^([A-Z])[-]?(\d+)$/);
  if (!m) return alert("Use format A-57 or B-720");

  const letter = m[1];
  const num = Number(m[2]);
  const key = `${letter}-${num}`;

  let found = null;

  [state.currentSector,1,2,3].forEach(sec => {
    if (found) return;
    state.data[sec].forEach(block => {
      if (block.expanded.includes(key)) {
        found = { block, sector: sec };
      }
    });
  });

  if (!found) return alert("Block not found");

  // switch sector if required
  if (found.sector !== state.currentSector) {
    document.querySelectorAll(".tab").forEach(t =>
      t.classList.toggle("active", Number(t.dataset.sector) === found.sector)
    );
    loadSector(found.sector);
  }

  // highlight
  setTimeout(() => {
    const r = found.block._layer;
    if (!r) return;

    r.setStyle({ color:"#ffeb3b", weight:4, fillOpacity:0.6 });
    map.fitBounds(r.getBounds().pad(0.3));

    setTimeout(()=>{
      r.setStyle({ color:"#ff9800", weight:2, fillOpacity:0.35 });
    }, 3000);
  }, 400);
};

/* ---------------------------------------------------------
    JSON EXPORT/IMPORT
------------------------------------------------------------ */

document.getElementById("btnDownload").onclick = () => {
  const obj = { sectors: state.data };
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "township_map_ranges.json";
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById("btnLoad").onclick = () => {
  document.getElementById("jsonLoader").click();
};

document.getElementById("jsonLoader").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const json = JSON.parse(evt.target.result);
      state.data = json.sectors;
      renderStoredRectangles(state.currentSector);
      alert("JSON Loaded!");
    } catch(err) {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
};

/* ---------------------------------------------------------
    TAB CLICK HANDLING
------------------------------------------------------------ */

document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    loadSector(Number(tab.dataset.sector));
  };
});

// INITIAL LOAD
loadSector(1);

</script>

</body>
</html>
