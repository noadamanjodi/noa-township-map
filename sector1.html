<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sector-1 Township Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
html,body{
  height:100%;margin:0;
  font-family:Segoe UI,Arial;
  background:#f4f6fb;
}

/* HEADER */
header{
  background:#003f88;
  color:#fff;
  padding:12px 16px;
  font-size:18px;
  font-weight:600;
}

/* LAYOUT */
.app{height:100%;display:flex;flex-direction:column}
.main{flex:1;display:flex}

/* SIDEBAR */
.sidebar{
  width:320px;
  background:#fff;
  padding:14px;
  overflow:auto;
  box-shadow:2px 0 12px rgba(0,0,0,.1);
}
.panel{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}

/* INPUT */
input{
  width:100%;
  padding:9px;
  border-radius:8px;
  border:1px solid #cfd9e6;
  font-size:14px;
}

/* BUTTON */
.btn{
  width:100%;
  padding:10px;
  margin-top:8px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.yellow{background:#ffd24d}
.green{background:#b7e37b}
.blue{background:#b7d9ff}

/* MAP */
.mapWrap{flex:1}
#map{width:100%;height:100%}

/* TOOLTIP */
.leaflet-tooltip.myTip{
  background:#000;
  color:#fff;
  padding:4px 8px;
  border-radius:4px;
}

/* ADMIN */
#adminPanel{display:none}
</style>
</head>

<body>

<div class="app">
<header>Sector-1 Township Map</header>

<div class="main">

<!-- SIDEBAR -->
<aside class="sidebar">

  <div class="panel">
    <label>Search Block (B-529)</label>
    <input id="searchInput" placeholder="Enter block"/>
    <button id="searchBtn" class="btn yellow">Find</button>
  </div>

  <div class="panel">
    <button id="adminBtn" class="btn yellow">Admin Login</button>

    <div id="adminPanel">
      <input id="adminPass" type="password" placeholder="Admin password"/>
      <button id="adminUnlock" class="btn green">Unlock</button>
    </div>
  </div>

  <div class="panel" id="tools" style="display:none">
    <button id="toggleDraw" class="btn yellow">Enable Drawing</button>
    <button id="downloadJSON" class="btn green">Download JSON</button>
    <button id="saveGithub" class="btn blue">Save to GitHub</button>
  </div>

</aside>

<!-- MAP -->
<div class="mapWrap">
  <div id="map"></div>
</div>

</div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
/* ================= GLOBAL ================= */
const IMG_W = 4400, IMG_H = 3080;
const ADMIN = { unlocked:false };
let SECTOR_DATA = [];
let DRAW_LAYER;
let MAP, IMAGE_OVERLAY;
let DRAW_ENABLED = false;

/* ================= MAP INIT ================= */
MAP = L.map("map",{crs:L.CRS.Simple,minZoom:-4,maxZoom:4});

const bounds = [
  MAP.unproject([0, IMG_H], MAP.getMaxZoom()),
  MAP.unproject([IMG_W, 0], MAP.getMaxZoom())
];

IMAGE_OVERLAY = L.imageOverlay("./sector1.png", bounds).addTo(MAP);
MAP.fitBounds(bounds);
MAP.setMaxBounds(bounds);

/* DRAW LAYER */
DRAW_LAYER = L.featureGroup().addTo(MAP);

/* ================= LOAD JSON ================= */
fetch("https://raw.githubusercontent.com/noadamanjodi/noa-township-map/main/json/sector1.json?t="+Date.now())
.then(r=>r.json())
.then(j=>{
  SECTOR_DATA = j.sectors["1"] || [];
  renderBlocks();
});

/* ================= RENDER ================= */
function renderBlocks(){
  DRAW_LAYER.clearLayers();
  SECTOR_DATA.forEach(b=>{
    const r=L.rectangle(b.boundsLatLng,{
      color:"#ff9800",
      weight:2,
      fillOpacity:.35
    }).addTo(DRAW_LAYER);
    r.bindTooltip(b.rangeText,{className:"myTip"});
    b._layer=r;
  });
}

/* ================= SEARCH ================= */
searchBtn.onclick=()=>{
  const q=searchInput.value.trim().toUpperCase();
  if(!q)return;
  const hit=SECTOR_DATA.find(b=>b.expanded.includes(q));
  if(!hit)return alert("Not found");

  MAP.fitBounds(hit._layer.getBounds().pad(.3));
  hit._layer.setStyle({color:"#ff0",weight:4});
  setTimeout(()=>hit._layer.setStyle({color:"#ff9800",weight:2}),2000);
};

/* ================= ADMIN ================= */
adminBtn.onclick=()=>adminPanel.style.display="block";

adminUnlock.onclick=()=>{
  if(adminPass.value==="NALCO123"){
    ADMIN.unlocked=true;
    tools.style.display="block";
    alert("Admin unlocked");
  }else alert("Wrong password");
};

/* ================= DRAW ================= */
const drawCtrl=new L.Control.Draw({
  draw:{rectangle:{shapeOptions:{color:"#ff9800"}},polygon:false,marker:false,polyline:false,circle:false}
});

toggleDraw.onclick=()=>{
  if(!ADMIN.unlocked)return alert("Admin only");
  DRAW_ENABLED=!DRAW_ENABLED;
  toggleDraw.innerText=DRAW_ENABLED?"Disable Drawing":"Enable Drawing";
  DRAW_ENABLED?MAP.addControl(drawCtrl):MAP.removeControl(drawCtrl);
};

MAP.on(L.Draw.Event.CREATED,e=>{
  if(!DRAW_ENABLED)return;
  const range=prompt("Enter range (B-529-540)");
  if(!range)return;

  const expanded=expand(range);
  if(!expanded.length)return alert("Invalid");

  const b=e.layer.getBounds();
  const obj={
    id:"id_"+Date.now(),
    sector:1,
    rangeText:range.toUpperCase(),
    expanded,
    boundsLatLng:[
      [b.getSouth(),b.getWest()],
      [b.getNorth(),b.getEast()]
    ]
  };
  SECTOR_DATA.push(obj);
  renderBlocks();
});

/* ================= EXPAND ================= */
function expand(s){
  const m=s.replace(/\s+/g,"").toUpperCase().match(/^([A-Z])-(\d+)(?:-(\d+))?$/);
  if(!m)return[];
  const a=+m[2],b=+m[3]||a;
  return Array.from({length:Math.abs(b-a)+1},(_,i)=>`${m[1]}-${Math.min(a,b)+i}`);
}

/* ================= DOWNLOAD ================= */
downloadJSON.onclick=()=>{
  const blob=new Blob([JSON.stringify({sectors:{1:SECTOR_DATA}},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="sector1.json";
  a.click();
};

/* ================= SAVE TO GITHUB ================= */
saveGithub.onclick=async()=>{
  if(!ADMIN.unlocked)return alert("Admin only");

  let token=localStorage.getItem("GITHUB_TOKEN");
  if(!token){
    token=prompt("GitHub Token:");
    if(!token)return;
    localStorage.setItem("GITHUB_TOKEN",token);
  }

  const api=`https://api.github.com/repos/noadamanjodi/noa-township-map/contents/json/sector1.json`;
  const content=btoa(unescape(encodeURIComponent(JSON.stringify({sectors:{1:SECTOR_DATA}},null,2))));

  let sha=null;
  const r=await fetch(api,{headers:{Authorization:"Bearer "+token}});
  if(r.ok){sha=(await r.json()).sha;}

  const res=await fetch(api,{
    method:"PUT",
    headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
    body:JSON.stringify({message:"Update sector-1",content,sha})
  });

  alert(res.ok?"Saved to GitHub":"Save failed");
};
</script>

</body>
</html>
